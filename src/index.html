<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="main-container">
    <div class="canvas-container">
        <div class="controls-container">
            <div class="cycles-control">
                <label>Cycles: <span id="cyclesValue">2</span></label>
                <input type="range" id="cyclesSlider" min="1" max="80" step="1" value="2" class="slider">
            </div>
        </div>
        <canvas id="targetCanvas" width="800" height="200"></canvas>
    </div>

    <div class="canvas-container">
        <canvas id="attemptCanvas" width="800" height="200"></canvas>
    </div>

    <div class="navigation-controls">
        <button id="prevComponent" class="nav-button">&lt; Previous</button>
        <span id="componentNumber">Component 1 of X</span>
        <button id="nextComponent" class="nav-button">Next &gt;</button>
    </div>

    <div id="sliderContainer"></div>

    <div class="answer-container">
        <span id="answerString"></span>
        <button id="copyButton" class="copy-button">Copy</button>
    </div>
</div>

<script type="module">
    import {AudioHandler} from './lib/AudioHandler.mjs';
    import  {WaveformRenderer} from './lib/WaveformRenderer.mjs'

    // Parse frequency string
    var frequencyString = "1 1 0, 2 0.5 1, 2.5 0.5 1, 3 0.3 0.5, 4 0.25 0.75, 5 0.2 0.25";
    var answerString = "1 1 0";

    var currentComponentIndex = 0;
    var lastModifiedHarmonic = null;
    var numCycles = 2;
    var components = [];

    var audioHandler = new AudioHandler()
    const targetRenderer = new WaveformRenderer();
    const attemptRenderer = new WaveformRenderer();

    if (!document.getElementById('answer')) {
        var userComponents = [];
        var redPoints = null;
    }

    var activeIndicator = null;
    var indicatorTimeout = null;
    var activeInteractions = 0;

    function modifyUserComponents(index, property, value) {
        userComponents[index][property] = Number(formatOutputValue(value));
        drawAttempt();
        updateAnswerString();
        showFloatingValue(value, null, property);
    }

    function createFloatingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'floating-indicator';
        return indicator;
    }

    // Helper function to format frequency for display
    function formatOutputValue(value, precision = 2) {
        return value.toFixed(precision).replace(/\.?0+$/, '').replace(/([,.])\$/, '');
    }

    // Keep the showFloatingValue and updateAnswerString functions as they were
    function showFloatingValue(value, slider, type) {
        if (activeIndicator) {
            activeIndicator.remove();
        }
        clearTimeout(indicatorTimeout);

        const indicator = createFloatingIndicator();
        const answerContainer = document.querySelector('.navigation-controls');
        answerContainer.appendChild(indicator);

        indicator.textContent = formatOutputValue(value);
        indicator.style.opacity = '1';
        activeIndicator = indicator;

        indicatorTimeout = setTimeout(() => {
            indicator.style.opacity = '0';
            setTimeout(() => indicator.remove(), 200);
        }, 1500);
    }

    function prepareComponent(compStrings) {
        var theComponents = []
        for (var i = 0; i < compStrings.length; i++) {
            var parts = compStrings[i].trim().split(' ');
            theComponents.push({
                freq: parseFloat(parts[0]),
                amp: parseFloat(parts[1]),
                phase: parseFloat(parts[2])
            });
        }
        return theComponents;
    }

    function initializeComponents() {
        var compStrings = frequencyString.split(',');
        if (userComponents.length === 0 || !document.getElementById('answer')) {
            console.log('Reinitializing user components');
            console.log(document.getElementById('answer'));
            console.log("userComponents.length = " + userComponents.length);
            var userCompStrings = answerString.split(',');
            if (userCompStrings.length < compStrings.length) {
                for (var i = userCompStrings.length; i < compStrings.length; i++) {
                    userCompStrings.push("0 0 0");
                }
            }
            userComponents = prepareComponent(userCompStrings);
        }
        components = prepareComponent(compStrings);
    }

    function updateCycles() {
        numCycles = parseFloat(this.value);
        document.getElementById('cyclesValue').textContent = numCycles.toFixed(0);
        targetRenderer.redrawAll(numCycles, components, document.getElementById("targetCanvas"));
        drawAttempt();
    }

    function navigatePrev() {
        if (currentComponentIndex > 0) {
            currentComponentIndex--;
            updateComponentView();
        }
    }

    function navigateNext() {
        if (currentComponentIndex < components.length - 1) {
            currentComponentIndex++;
            updateComponentView();
        }
    }

    function updateComponentView() {
        document.getElementById('componentNumber').textContent =
            'Component ' + (currentComponentIndex + 1) + ' of ' + components.length;

        document.getElementById('prevComponent').disabled = currentComponentIndex === 0;
        document.getElementById('nextComponent').disabled = currentComponentIndex === components.length - 1;

        var container = document.getElementById('sliderContainer');
        container.innerHTML = '';
        container.appendChild(createComponent(currentComponentIndex));

        updateSliderValues();
    }

    function updateSliderValues() {
        var component = userComponents[currentComponentIndex];
        var container = document.querySelector('.component-container');

        ['freq', 'amp', 'phase'].forEach(controlName => {
            var slider = container.querySelector(`[data-control="${controlName}"]`);
            if (slider) {
                slider.value = convertToSliderValue(controlName, component[controlName]);
            }
        });
    }

    // Convert actual value to slider value
    function convertToSliderValue(controlName, value) {
        if (controlName === 'freq') {
            if (value === 0) return 0;

            if (value < 1) {
                // For fractions (1/3 to 1), map to 0-0.25 range
                // 1/3 → 0
                // 1   → 0.25
                return 0.25 * (3 * value - 1) / 2;
            } else {
                // For multipliers (1 to 40), map to 0.25-1 range using logarithmic scale
                // 1  → 0.25
                // 40 → 1.0
                return 0.25 + 0.75 * (Math.log2(value) / Math.log2(40));
            }
        }
        return value;
    }

    // Convert slider value to actual value
    function convertFromSliderValue(controlName, sliderValue) {
        if (controlName === 'freq') {
            if (sliderValue === 0) return 0;

            if (sliderValue < 0.25) {
                // Convert 0-0.25 range to fractions (1/3 to 1)
                // 0    → 1/3
                // 0.25 → 1
                return (2 * sliderValue / 0.25 + 1) / 3;
            } else {
                // Convert 0.25-1 range to multipliers (1 to 40)
                // 0.25 → 1
                // 1.0  → 40
                const normalizedSlider = (sliderValue - 0.25) / 0.75;
                return Math.pow(40, normalizedSlider);
            }
        }
        return sliderValue;
    }

    function createComponent(index) {
        var div = document.createElement('div');
        div.className = 'component-container';

        var title = document.createElement('div');
        title.textContent = 'Component ' + (index + 1);
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '10px';
        div.appendChild(title);

        var controls = [
            {name: 'freq', label: 'F', max: 1, step: 0.01}, // max is now 1 for exponential scaling
            {name: 'amp', label: 'A', max: 1, min: -1, step: 0.01}, // amplitude now goes from -1 to 1
            {name: 'phase', label: 'P', max: 1, step: 0.01}
        ];

        for (var i = 0; i < controls.length; i++) {
            var control = controls[i];
            var container = document.createElement('div');
            container.className = 'slider-container';

            var row = document.createElement('div');
            row.className = 'slider-row';

            // Minus button
            var minusBtn = document.createElement('button');
            minusBtn.className = 'adjust-button';
            minusBtn.textContent = '-';
            minusBtn.onclick = createAdjustHandler(index, control.name, -control.step);

            var label = document.createElement('span');
            label.className = 'slider-label';
            label.textContent = control.label + ':';

            var slider = document.createElement('input');
            slider.type = 'range';
            slider.className = 'slider';
            slider.min = control.min || 0;
            slider.max = control.max;
            slider.step = control.step;
            slider.value = convertToSliderValue(control.name, userComponents[index][control.name]);
            slider.setAttribute('data-control', control.name);
            slider.addEventListener('mousedown', createSliderHandler(index, control.name));
            slider.addEventListener('touchstart', createSliderHandler(index, control.name));
            slider.addEventListener('input', createSliderHandler(index, control.name));
            slider.addEventListener('mouseup', createSliderTouchEndHandler(index, control.name));
            slider.addEventListener('touchend', createSliderTouchEndHandler(index, control.name));

            // Plus button
            var plusBtn = document.createElement('button');
            plusBtn.className = 'adjust-button';
            plusBtn.textContent = '+';
            plusBtn.onclick = createAdjustHandler(index, control.name, control.step);

            row.appendChild(minusBtn);
            row.appendChild(label);
            row.appendChild(slider);
            row.appendChild(plusBtn);
            container.appendChild(row);
            div.appendChild(container);
        }

        return div;
    }

    function createAdjustHandler(index, controlName, step) {
        return function () {
            var slider = document.querySelector(`[data-control="${controlName}"]`);
            var currentActualValue = userComponents[index][controlName];

            // Calculate new actual value
            var newValue;
            if (controlName === 'freq') {
                var lStep = step;
                var round = 2;
                newValue = currentActualValue + lStep;
                const roundedValue = Number(newValue.toFixed(round));
                if (lStep > 0 && roundedValue > currentActualValue || lStep < 0 && roundedValue > currentActualValue)
                    newValue = roundedValue;
                newValue = Math.min(Math.max(newValue, 0), 40);
            } else {
                // For other controls, use linear adjustment
                newValue = currentActualValue + step;
                newValue = Math.min(Math.max(newValue, parseFloat(slider.min) || 0), parseFloat(slider.max));
            }

            // Convert back to slider value
            slider.value = convertToSliderValue(controlName, newValue);

            activeInteractions++;
            lastModifiedHarmonic = index;
            modifyUserComponents(index, controlName, newValue);

            // Clear lastModifiedHarmonic after a short delay
            setTimeout(() => {
                activeInteractions--;
                if (activeInteractions === 0) {
                    drawAttempt();
                    audioHandler.playWaveform(userComponents); // Play sound when finished adjusting
                }
            }, 2000);
        };
    }

    function createSliderHandler(index, controlName) {
        return function (event) {
            var sliderValue = parseFloat(this.value);
            var newValue = convertFromSliderValue(controlName, sliderValue);

            if (event.type === 'mousedown' || event.type === 'touchstart') {
                activeInteractions++;
                lastModifiedHarmonic = index;
            }

            modifyUserComponents(index, controlName, newValue);
        };
    }

    function createSliderTouchEndHandler(index, controlName) {
        return function (event) {
            if (activeInteractions > 0) {
                activeInteractions--;
                if (activeInteractions === 0) {
                    drawAttempt();
                    audioHandler.playWaveform(userComponents); // Play sound when finished adjusting
                }
            }
        };
    }

    function updateAnswerString() {
        const answerStr = userComponents.map(comp => {
            let freq = formatOutputValue(comp.freq);
            let amp = formatOutputValue(comp.amp);
            let phase = formatOutputValue(comp.phase);
            return `${freq} ${amp} ${phase}`;
        }).join(', ');

        document.getElementById('answerString').textContent = answerStr;

        // Update typeans if it exists
        const typeans = document.getElementById('typeans');
        if (typeans) {
            typeans.value = answerStr;
        }
    }

    function initializeCopyButton() {
        document.getElementById('copyButton').onclick = function () {
            var text = document.getElementById('answerString').textContent;
            navigator.clipboard.writeText(text).then(function () {
                var originalText = this.textContent;
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 1000);
            }.bind(this));
        };
    }

    function drawAttempt() {
        var canvas = document.getElementById('attemptCanvas');
        var ctx = attemptRenderer.setupCanvas(canvas);
        var rect = canvas.getBoundingClientRect();

        const userComponentsPoints = attemptRenderer.calculateWaveform(rect.width, rect.height, userComponents, numCycles);
        if (lastModifiedHarmonic !== null) {
            var userComponentsWithoutTheModifiedOne = JSON.parse(JSON.stringify(userComponents));
            userComponentsWithoutTheModifiedOne[lastModifiedHarmonic] = {freq: 0, amp: 0, phase: 0};

            if (activeInteractions > 0) {
                var withoutModifiedCompPoints =
                    attemptRenderer.calculateWaveform(rect.width, rect.height, userComponentsWithoutTheModifiedOne, numCycles);
                if (redPoints === null) {
                    redPoints = userComponentsPoints;
                }
                attemptRenderer.scheduleMorphicDraw(canvas, redPoints, withoutModifiedCompPoints, 'red', ctx, numCycles);
                attemptRenderer.scheduleMorphicDraw(canvas, userComponentsPoints, userComponentsPoints, '#d3d2d2', ctx, numCycles);
                redPoints = withoutModifiedCompPoints;
            } else if (activeInteractions === 0) {
                if (redPoints === null) {
                    redPoints = attemptRenderer.calculateWaveform(rect.width, rect.height, userComponentsWithoutTheModifiedOne, numCycles);
                }
                attemptRenderer.scheduleMorphicDraw(canvas, redPoints, userComponentsPoints, 'red', ctx, numCycles);
                redPoints = userComponentsPoints;
                lastModifiedHarmonic = null;
            }
        } else {
            if (redPoints === null) {
                redPoints = attemptRenderer.calculateWaveform(rect.width, rect.height, [{
                    amp: 0,
                    freq: 0,
                    phase: 0
                }], numCycles);
            }
            attemptRenderer.scheduleMorphicDraw(canvas, userComponentsPoints, userComponentsPoints, 'red', ctx, numCycles);
            redPoints = userComponentsPoints;
        }
    }

    // Initialize everything
    function init() {
        initializeComponents();
        audioHandler.initializeAudioHandlers(document.getElementById("targetCanvas"), components);
        audioHandler.initializeAudioHandlers(document.getElementById('attemptCanvas'), userComponents);

        document.getElementById('cyclesSlider').onchange = updateCycles;
        document.getElementById('cyclesSlider').oninput = updateCycles;
        document.getElementById('prevComponent').onclick = navigatePrev;
        document.getElementById('nextComponent').onclick = navigateNext;

        updateComponentView();
        targetRenderer.redrawAll(numCycles, components, document.getElementById("targetCanvas"));
        drawAttempt();
        updateAnswerString();
        initializeCopyButton();

        // Handle window resize
        var resizeTimer = null;
        window.onresize = function () {
            if (resizeTimer) {
                clearTimeout(resizeTimer);
            }
            resizeTimer = setTimeout(() => {
                targetRenderer.redrawAll(numCycles, components, document.getElementById("targetCanvas"));
                drawAttempt();
            }, 250);
        };
    }

    // Start the application
    console.log('Script starting...');
    init();
    console.log('Script finished initialization');
</script>
</body>
</html>
