<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="main-container">
    <div class="canvas-container">
        <div class="controls-container">
            <div class="cycles-control">
                <label>Cycles: <span id="cyclesValue">2</span></label>
                <input type="range" id="cyclesSlider" min="1" max="80" step="1" value="2" class="slider">
            </div>
        </div>
        <canvas id="targetCanvas" width="800" height="200"></canvas>
    </div>

    <div class="canvas-container">
        <canvas id="attemptCanvas" width="800" height="200"></canvas>
    </div>

    <div class="navigation-controls">
        <button id="prevComponent" class="nav-button">&lt; Previous</button>
        <span id="componentNumber">Component 1 of X</span>
        <button id="nextComponent" class="nav-button">Next &gt;</button>
    </div>

    <div id="sliderContainer"></div>

    <div class="answer-container">
        <span id="answerString"></span>
        <button id="copyButton" class="copy-button">Copy</button>
    </div>
</div>

<script type="module">
    import {AudioHandler} from './lib/AudioHandler.mjs';
    import  {WaveformRenderer} from './lib/WaveformRenderer.mjs'
    import {ComponentManager} from './lib/ComponentManager.mjs';

    // Parse frequency string
    var frequencyString = "1 1 0, 2 0.5 1, 2.5 0.5 1, 3 0.3 0.5, 4 0.25 0.75, 5 0.2 0.25";
    var answerString = "1 1 0";
    var numCycles = 2;

    const audioHandler = new AudioHandler();
    const targetRenderer = new WaveformRenderer();
    const attemptRenderer = new WaveformRenderer();
    const componentManager = new ComponentManager();

    if (!document.getElementById('answer')) {
        // var userComponents = [];
        var redPoints = null;
    }

    function updateCycles() {
        numCycles = parseFloat(this.value);
        document.getElementById('cyclesValue').textContent = numCycles.toFixed(0);
        targetRenderer.redrawAll(numCycles, componentManager.components, document.getElementById("targetCanvas"));
        drawAttempt();
    }

    function updateAnswerString() {
        const answerStr = userComponents.map(comp => {
            let freq = formatOutputValue(comp.freq);
            let amp = formatOutputValue(comp.amp);
            let phase = formatOutputValue(comp.phase);
            return `${freq} ${amp} ${phase}`;
        }).join(', ');

        document.getElementById('answerString').textContent = answerStr;

        // Update typeans if it exists
        const typeans = document.getElementById('typeans');
        if (typeans) {
            typeans.value = answerStr;
        }
    }

    function initializeCopyButton() {
        document.getElementById('copyButton').onclick = function () {
            var text = document.getElementById('answerString').textContent;
            navigator.clipboard.writeText(text).then(function () {
                var originalText = this.textContent;
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 1000);
            }.bind(this));
        };
    }

    function drawAttempt() {
        var canvas = document.getElementById('attemptCanvas');
        var ctx = attemptRenderer.setupCanvas(canvas);
        var rect = canvas.getBoundingClientRect();

        const userComponentsPoints = attemptRenderer.calculateWaveform(rect.width, rect.height, componentManager.userComponents, numCycles);
        if (componentManager.lastModifiedHarmonic !== null) {
            var userComponentsWithoutTheModifiedOne = JSON.parse(JSON.stringify(componentManager.userComponents));
            userComponentsWithoutTheModifiedOne[componentManager.lastModifiedHarmonic] = {freq: 0, amp: 0, phase: 0};

            if (componentManager.activeInteractions > 0) {
                var withoutModifiedCompPoints =
                    attemptRenderer.calculateWaveform(rect.width, rect.height, userComponentsWithoutTheModifiedOne, numCycles);
                if (redPoints === null) {
                    redPoints = userComponentsPoints;
                }
                attemptRenderer.scheduleMorphicDraw(canvas, redPoints, withoutModifiedCompPoints, 'red', ctx, numCycles);
                attemptRenderer.scheduleMorphicDraw(canvas, userComponentsPoints, userComponentsPoints, '#d3d2d2', ctx, numCycles);
                redPoints = withoutModifiedCompPoints;
            } else if (componentManager.activeInteractions === 0) {
                if (redPoints === null) {
                    redPoints = attemptRenderer.calculateWaveform(rect.width, rect.height, userComponentsWithoutTheModifiedOne, numCycles);
                }
                attemptRenderer.scheduleMorphicDraw(canvas, redPoints, userComponentsPoints, 'red', ctx, numCycles);
                redPoints = userComponentsPoints;
                componentManager.lastModifiedHarmonic = null;
            }
        } else {
            if (redPoints === null) {
                redPoints = attemptRenderer.calculateWaveform(rect.width, rect.height, [{
                    amp: 0,
                    freq: 0,
                    phase: 0
                }], numCycles);
            }
            attemptRenderer.scheduleMorphicDraw(canvas, userComponentsPoints, userComponentsPoints, 'red', ctx, numCycles);
            redPoints = userComponentsPoints;
        }
    }

    // Initialize everything
    function init() {
        // Set up component manager callbacks
        componentManager.onComponentUpdate = () => {
            drawAttempt();
            componentManager.updateAnswerString();
        };
        componentManager.onInteractionComplete = () => {
            audioHandler.playWaveform(componentManager.userComponents);
        };

        // Initialize components
        componentManager.initializeComponents(frequencyString, answerString);

        // Initialize audio handlers
        audioHandler.initializeAudioHandlers(document.getElementById("targetCanvas"), componentManager.components);
        audioHandler.initializeAudioHandlers(document.getElementById('attemptCanvas'), componentManager.userComponents);

        // Set up event listeners
        document.getElementById('cyclesSlider').onchange = updateCycles;
        document.getElementById('cyclesSlider').oninput = updateCycles;
        document.getElementById('prevComponent').onclick = () => componentManager.navigatePrev();
        document.getElementById('nextComponent').onclick = () => componentManager.navigateNext();

        // Initialize UI
        componentManager.updateComponentView();
        targetRenderer.redrawAll(numCycles, componentManager.components, document.getElementById("targetCanvas"));
        drawAttempt();
        componentManager.updateAnswerString();
        initializeCopyButton();

        // Handle window resize
        var resizeTimer = null;
        window.onresize = function () {
            if (resizeTimer) {
                clearTimeout(resizeTimer);
            }
            resizeTimer = setTimeout(() => {
                targetRenderer.redrawAll(numCycles, componentManager.components, document.getElementById("targetCanvas"));
                drawAttempt();
            }, 250);
        };
    }

    // Start the application
    init();
</script>
</body>
</html>
