<!DOCTYPE html>
<html>
<body>
<div style="width: 800px; margin: 0 auto;">
    <div>
        <h3>Target Waveform</h3>
        <div style="margin-bottom: 10px;">
            <label>Cycles of fundamental: <span id="cyclesValue">2.0</span></label>
            <input type="range" id="cyclesSlider" min="0.5" max="10" step="0.5" value="2" style="width: 300px;">
            <div style="margin-top: 5px;">
                <input type="checkbox" id="showGridLines" checked>
                <label for="showGridLines">Show cycle grid lines</label>
            </div>
        </div>
        <canvas id="targetCanvas" width="800" height="200" style="border:1px solid #ddd;"></canvas>
    </div>

    <div style="margin-top: 20px;">
        <h3>Your Attempt</h3>
        <canvas id="attemptCanvas" width="800" height="200" style="border:1px solid #ddd;"></canvas>
        <div id="sliderContainer" style="margin-top: 10px;"></div>
    </div>
</div>

<script>
    // For testing - in Anki this would be replaced with {{frequencies}}
    const frequencyString = "1 1 0, 2 0.5 1, 2.5 0.5 1";

    // Parse frequency string into array of {freq, amplitude, phase} objects
    const components = frequencyString.split(',').map(comp => {
        const [freq, amp, phase] = comp.trim().split(' ').map(Number);
        return { freq, amp, phase };
    });

    let lastModifiedHarmonic = null;
    const userComponents = components.map(comp => ({
        freq: 0,
        amp: 0,
        phase: 0
    }));

    let numCycles = 2;
    let showGrid = true;

    const cyclesSlider = document.getElementById('cyclesSlider');
    const cyclesValue = document.getElementById('cyclesValue');
    const gridCheckbox = document.getElementById('showGridLines');

    gridCheckbox.onchange = () => {
        showGrid = gridCheckbox.checked;
        redrawAll();
    };

    cyclesSlider.oninput = () => {
        numCycles = parseFloat(cyclesSlider.value);
        cyclesValue.textContent = numCycles.toFixed(1);
        redrawAll();
    };

    function redrawAll() {
        const targetCanvas = document.getElementById('targetCanvas');
        const targetCtx = targetCanvas.getContext('2d');
        targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
        drawWaveform(targetCanvas, components, true);
        drawAttempt();
    }

    function createSliders() {
        const container = document.getElementById('sliderContainer');
        container.innerHTML = ''; // Clear existing sliders

        components.forEach((comp, i) => {
            const harmonicNum = i + 1;
            const div = document.createElement('div');
            div.style.marginBottom = '20px';
            div.style.padding = '10px';
            div.style.border = '1px solid #ddd';
            div.style.borderRadius = '5px';

            // Component label
            const label = document.createElement('div');
            label.textContent = `Component ${harmonicNum}:`;
            label.style.marginBottom = '10px';
            label.style.fontWeight = 'bold';
            div.appendChild(label);

            // Frequency slider
            const freqDiv = document.createElement('div');
            freqDiv.style.marginBottom = '10px';

            const freqLabel = document.createElement('label');
            freqLabel.textContent = 'Frequency: ';

            const freqValue = document.createElement('span');
            freqValue.id = `freqValue${harmonicNum}`;
            freqValue.textContent = '0.00';

            const freqSlider = document.createElement('input');
            freqSlider.type = 'range';
            freqSlider.min = 0;
            freqSlider.max = 10;
            freqSlider.step = 0.1;
            freqSlider.value = 0;
            freqSlider.style.width = '300px';

            freqDiv.appendChild(freqLabel);
            freqDiv.appendChild(freqSlider);
            freqDiv.appendChild(freqValue);

            // Amplitude slider
            const ampDiv = document.createElement('div');
            ampDiv.style.marginBottom = '10px';

            const ampLabel = document.createElement('label');
            ampLabel.textContent = 'Amplitude: ';

            const ampValue = document.createElement('span');
            ampValue.id = `ampValue${harmonicNum}`;
            ampValue.textContent = '0.00';

            const ampSlider = document.createElement('input');
            ampSlider.type = 'range';
            ampSlider.min = 0;
            ampSlider.max = 1;
            ampSlider.step = 0.01;
            ampSlider.value = 0;
            ampSlider.style.width = '300px';

            ampDiv.appendChild(ampLabel);
            ampDiv.appendChild(ampSlider);
            ampDiv.appendChild(ampValue);

            // Phase slider
            const phaseDiv = document.createElement('div');

            const phaseLabel = document.createElement('label');
            phaseLabel.textContent = 'Phase: ';

            const phaseValue = document.createElement('span');
            phaseValue.id = `phaseValue${harmonicNum}`;
            phaseValue.textContent = '0.00';

            const phaseSlider = document.createElement('input');
            phaseSlider.type = 'range';
            phaseSlider.min = 0;
            phaseSlider.max = 1;
            phaseSlider.step = 0.01;
            phaseSlider.value = 0;
            phaseSlider.style.width = '300px';

            phaseDiv.appendChild(phaseLabel);
            phaseDiv.appendChild(phaseSlider);
            phaseDiv.appendChild(phaseValue);

            // Add event listeners
            freqSlider.oninput = () => {
                const newValue = parseFloat(freqSlider.value);
                freqValue.textContent = newValue.toFixed(2);
                userComponents[i].freq = newValue;
                lastModifiedHarmonic = i;
                drawAttempt();
            };

            ampSlider.oninput = () => {
                const newValue = parseFloat(ampSlider.value);
                ampValue.textContent = newValue.toFixed(2);
                userComponents[i].amp = newValue;
                lastModifiedHarmonic = i;
                drawAttempt();
            };

            phaseSlider.oninput = () => {
                const newValue = parseFloat(phaseSlider.value);
                phaseValue.textContent = newValue.toFixed(2);
                userComponents[i].phase = newValue;
                lastModifiedHarmonic = i;
                drawAttempt();
            };

            div.appendChild(freqDiv);
            div.appendChild(ampDiv);
            div.appendChild(phaseDiv);
            container.appendChild(div);
        });
    }

    function drawGridLines(canvas) {
        if (!showGrid) return;

        const ctx = canvas.getContext('2d');
        const cycleWidth = canvas.width / numCycles;

        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);

        for (let i = 0; i <= numCycles; i++) {
            const x = i * cycleWidth;
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }

        ctx.setLineDash([]);
    }

    function drawWaveform(canvas, components, isTarget = false) {
        const ctx = canvas.getContext('2d');

        drawGridLines(canvas);

        // Draw center line
        ctx.strokeStyle = '#999';
        ctx.beginPath();
        ctx.moveTo(0, canvas.height/2);
        ctx.lineTo(canvas.width, canvas.height/2);
        ctx.stroke();

        // Calculate points
        const points = new Array(canvas.width).fill(0);

        components.forEach(comp => {
            if (comp.freq === 0) return; // Skip components with zero frequency
            for (let x = 0; x < canvas.width; x++) {
                const t = x * (Math.PI * 2 * numCycles / canvas.width);
                points[x] += comp.amp * Math.sin(comp.freq * t + comp.phase * Math.PI * 2);
            }
        });

        // Scale to fit canvas
        const maxAmp = Math.max(1, ...points.map(Math.abs));
        const scale = (canvas.height/2 - 20) / maxAmp;

        // Draw waveform
        ctx.strokeStyle = isTarget ? 'blue' : 'red';
        ctx.lineWidth = 2;
        ctx.beginPath();
        points.forEach((y, x) => {
            const scaledY = y * scale + canvas.height/2;
            if (x === 0) ctx.moveTo(x, scaledY);
            else ctx.lineTo(x, scaledY);
        });
        ctx.stroke();
    }

    function drawSingleHarmonic(canvas, component) {
        if (component.freq === 0) return; // Skip components with zero frequency

        const ctx = canvas.getContext('2d');
        const points = new Array(canvas.width).fill(0);

        for (let x = 0; x < canvas.width; x++) {
            const t = x * (Math.PI * 2 * numCycles / canvas.width);
            points[x] = component.amp * Math.sin(component.freq * t + component.phase * Math.PI * 2);
        }

        // Scale consistently
        const maxAmp = Math.max(1, ...points.map(Math.abs));
        const scale = (canvas.height/2 - 20) / maxAmp;

        // Draw waveform
        ctx.strokeStyle = '#888';
        ctx.lineWidth = 1;
        ctx.beginPath();
        points.forEach((y, x) => {
            const scaledY = y * scale + canvas.height/2;
            if (x === 0) ctx.moveTo(x, scaledY);
            else ctx.lineTo(x, scaledY);
        });
        ctx.stroke();
    }

    function drawAttempt() {
        const canvas = document.getElementById('attemptCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawGridLines(canvas);
        drawWaveform(canvas, userComponents);

        if (lastModifiedHarmonic !== null) {
            drawSingleHarmonic(canvas, userComponents[lastModifiedHarmonic]);
        }
    }

    // Initial setup
    createSliders();
    drawWaveform(document.getElementById('targetCanvas'), components, true);
    drawAttempt();
</script>
</body>
</html>
